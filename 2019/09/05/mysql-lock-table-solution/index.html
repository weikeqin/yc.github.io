<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">



  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">










<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '4MYO215Y0R',
      apiKey: '63ec2e526818df599ef4caa3c72f3459',
      indexName: 'weikeqin',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键字","hits_empty":"没有找到相关内容: ${query}","hits_stats":"${hits} 条相关记录，共耗时 ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。 (1)  遇到锁表快速解决办法　　依次执行1-6步，运行第6步生成的语句即可。 　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。     1.　 第1步　查看表是否在使用。   show open tables where in_use &amp;gt; 0 ;如果查询结果为空。则证明表没有在">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 锁表后快速解决方法 及 锁表原因">
<meta property="og:url" content="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/index.html">
<meta property="og:site_name" content="沧海一粟">
<meta property="og:description" content="前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。 (1)  遇到锁表快速解决办法　　依次执行1-6步，运行第6步生成的语句即可。 　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。     1.　 第1步　查看表是否在使用。   show open tables where in_use &amp;gt; 0 ;如果查询结果为空。则证明表没有在">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-11-04T06:36:52.383Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL 锁表后快速解决方法 及 锁表原因">
<meta name="twitter:description" content="前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。 (1)  遇到锁表快速解决办法　　依次执行1-6步，运行第6步生成的语句即可。 　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。     1.　 第1步　查看表是否在使用。   show open tables where in_use &amp;gt; 0 ;如果查询结果为空。则证明表没有在">



  <link rel="alternate" href="/atom.xml" title="沧海一粟" type="application/atom+xml">




  <link rel="canonical" href="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MySQL 锁表后快速解决方法 及 锁表原因 | 沧海一粟</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d4a41cd2b759aa5c8e03c8d94cd23ed9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">沧海一粟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
    
      
    
    <a href="undefined" class="github-corner" target="_blank" title aria-label><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://weikeqin.com/2019/09/05/mysql-lock-table-solution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WKQ">
      <meta itemprop="description" content="不积跬步无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沧海一粟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL 锁表后快速解决方法 及 锁表原因
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-05 22:14:48" itemprop="dateCreated datePublished" datetime="2019-09-05T22:14:48+08:00">2019-09-05</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/05/mysql-lock-table-solution/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2019/09/05/mysql-lock-table-solution/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/09/05/mysql-lock-table-solution/" class="leancloud_visitors" data-flag-title="MySQL 锁表后快速解决方法 及 锁表原因">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>  前几天同事在晚上上线的时候执行sql语句造成锁表，想总结一下以避免后续发生。</p>
<h1 id="1-遇到锁表快速解决办法"><a href="#1-遇到锁表快速解决办法" class="headerlink" title="(1)  遇到锁表快速解决办法"></a>(1)  遇到锁表快速解决办法</h1><p>　　依次执行1-6步，运行第6步生成的语句即可。</p>
<p>　　如果特别着急，运行 1  2  6 步 以及第6步生成的kill语句 即可。  </p>
<p>  1.　<strong> 第1步　查看表是否在使用。</strong></p>
<blockquote>
<p> <code>show open tables where in_use &gt; 0 ;</code><br>如果查询结果为空。则证明表没有在使用。结束。</p>
</blockquote>
<blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show open tables where in_use &gt; 0 ;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p> 如果查询结果不为空，继续后续的步骤。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show open tables where in_use &gt; 0 ;</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">| test     | t     |      1 |           0 |</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>2.　<strong> 第2步　查看数据库当前的进程，看一下有无正在执行的慢SQL记录线程。  </strong></p>
<blockquote>
<p> <code>show  processlist;</code></p>
</blockquote>
<p>3.　<strong> 第3步　当前运行的所有事务  </strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_TRX;</code></p>
</blockquote>
<p>4.　<strong> 第4步　当前出现的锁  </strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_LOCKs;</code></p>
</blockquote>
<p>5.　<strong> 第5步　锁等待的对应关系 </strong></p>
<blockquote>
<p><code>SELECT * FROM information_schema.INNODB_LOCK_waits;</code></p>
</blockquote>
<blockquote>
<p> 看事务表INNODB_TRX，里面是否有正在锁定的事务线程，看看ID是否在show processlist里面的sleep线程中，如果是，就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。<br> 搜索的结果是在事务表发现了很多任务，这时候最好都kill掉。</p>
</blockquote>
<p>6.　<strong> 第6步　批量删除事务表中的事务 </strong></p>
<blockquote>
<p> 这里用的方法是：通过information_schema.processlist表中的连接信息生成需要处理掉的MySQL连接的语句临时文件，然后执行临时文件中生成的指令。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">concat</span>(<span class="string">'KILL '</span>,<span class="keyword">id</span>,<span class="string">';'</span>) </span><br><span class="line"><span class="keyword">FROM</span> information_schema.processlist p </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span>  information_schema.INNODB_TRX x </span><br><span class="line"><span class="keyword">ON</span> p.id=x.trx_mysql_thread_id </span><br><span class="line"><span class="keyword">WHERE</span> db=<span class="string">'test'</span>;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p> 记得修改对应的数据库名。</p>
</blockquote>
<blockquote>
<p> 这个语句执行后结果如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT concat('KILL ',id,';')  FROM information_schema.processlist p  INNER JOIN  information_schema.INNODB_TRX x  ON p.id=x.trx_mysql_thread_id  WHERE db='test';</span><br><span class="line">+<span class="comment">------------------------+</span></span><br><span class="line">| concat('<span class="keyword">KILL</span> <span class="string">',id,'</span>;') |</span><br><span class="line">+<span class="comment">------------------------+</span></span><br><span class="line">| <span class="keyword">KILL</span> <span class="number">42</span>;               |</span><br><span class="line">| <span class="keyword">KILL</span> <span class="number">40</span>;               |</span><br><span class="line">+<span class="comment">------------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p> 执行结果里的两个kill语句即可解决锁表。</p>
</blockquote>
<a id="more"></a>  
<p>　首先问几个问题：</p>
<ol>
<li>MySQL里有哪些锁？</li>
<li>如何造成锁表？</li>
<li>如何造成死锁？</li>
<li>全局锁加锁方法的执行命令是什么?主要的应用场景是什么?</li>
<li>做整库备份时为什么要加全局锁?</li>
<li>MySQL的自带备份工具, 使用什么参数可以确保一致性视图, 在什么场景下不适用?</li>
<li>不建议使用set global readonly = true的方法加全局锁有哪两点原因?</li>
<li>表级锁有哪两种类型? 各自的使用场景是什么?</li>
<li>MDL中读写锁之间的互斥关系怎样的?</li>
<li>如何安全的给小表增加字段?</li>
</ol>
<h1 id="2-复盘"><a href="#2-复盘" class="headerlink" title="(2) 复盘"></a>(2) 复盘</h1><p>  自己创建了一个测试的表<code>t</code>，插入了两条数据。然后手动构造锁表和死锁模拟。</p>
<h2 id="2-1-创建表t并插入2条数据"><a href="#2-1-创建表t并插入2条数据" class="headerlink" title="(2.1) 创建表t并插入2条数据"></a>(2.1) 创建表t并插入2条数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t`</span> (<span class="keyword">id</span>, c)</span><br><span class="line"><span class="keyword">VALUES</span> </span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-2-准备多个shell模拟锁表"><a href="#2-2-准备多个shell模拟锁表" class="headerlink" title="(2.2) 准备多个shell模拟锁表"></a>(2.2) 准备多个shell模拟锁表</h2><pre><code>可以看到我打开三个shell，用root创建了三个连接，分别是 15  40  41 
</code></pre><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">| Id | User        | Host            | db   | Command | Time | State                    | Info             | Progress |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">|  1 | system user |                 | NULL | Daemon  | NULL | InnoDB <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> coordinator | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">5</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">shutdown</span> <span class="keyword">handler</span>  | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">15</span> | root        | localhost:<span class="number">49914</span> | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | Init                     | <span class="keyword">show</span> <span class="keyword">processlist</span> |    <span class="number">0.000</span> |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">processlist</span> ;</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">| Id | User        | Host            | db   | Command | Time | State                    | Info             | Progress |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">|  1 | system user |                 | NULL | Daemon  | NULL | InnoDB <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> coordinator | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">5</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">shutdown</span> <span class="keyword">handler</span>  | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">15</span> | root        | localhost:<span class="number">49914</span> | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | Init                     | <span class="keyword">show</span> <span class="keyword">processlist</span> |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">40</span> | root        | localhost:<span class="number">50872</span> | <span class="keyword">test</span> | <span class="keyword">Sleep</span>   |   <span class="number">41</span> |                          | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">processlist</span> ;</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">| Id | User        | Host            | db   | Command | Time | State                    | Info             | Progress |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">|  1 | system user |                 | NULL | Daemon  | NULL | InnoDB <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> coordinator | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">5</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">shutdown</span> <span class="keyword">handler</span>  | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">15</span> | root        | localhost:<span class="number">49914</span> | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | Init                     | <span class="keyword">show</span> <span class="keyword">processlist</span> |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">40</span> | root        | localhost:<span class="number">50872</span> | <span class="keyword">test</span> | <span class="keyword">Sleep</span>   |   <span class="number">64</span> |                          | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">41</span> | root        | localhost:<span class="number">50888</span> | <span class="keyword">test</span> | <span class="keyword">Sleep</span>   |    <span class="number">5</span> |                          | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="2-3-模拟锁表"><a href="#2-3-模拟锁表" class="headerlink" title="(2.3) 模拟锁表"></a>(2.3) 模拟锁表</h2><p>  在第一个shell里观察</p>
<p>  在第二个shell里执行 <code>start transaction; delete from t where c=1 ;</code>  故意打开事务，然后执行语句不提交，占用写锁。</p>
<p>  在第三个shell里执行 <code>delete from t where c=1 ;</code> 执行删除语句，造成锁表。</p>
<p>  这个时候 session3在等待session2释放写锁。这个时候已经锁表了。</p>
<p>  如果再在 第三个shell里执行 <code>delete from t where c=2 ;</code></p>
<p>  在 第二个shell里执行 <code>delete from t where c=1 ;</code> </p>
<p>  就会相互等待，造成死锁。</p>
<h2 id="2-4-锁表后查看"><a href="#2-4-锁表后查看" class="headerlink" title="(2.4) 锁表后查看"></a>(2.4) 锁表后查看</h2><p>  然后在第一个shell里查看 </p>
<h3 id="2-4-1-查看是否锁表"><a href="#2-4-1-查看是否锁表" class="headerlink" title="(2.4.1)查看是否锁表"></a>(2.4.1)查看是否锁表</h3><p>  可以看到下面的查询语句有结果，确实是锁表了。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show open tables where in_use &gt; 0 ;</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">| test     | t     |      1 |           0 |</span><br><span class="line">+<span class="comment">----------+-------+--------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="2-4-2-查看数据库当前的进程"><a href="#2-4-2-查看数据库当前的进程" class="headerlink" title="(2.4.2) 查看数据库当前的进程"></a>(2.4.2) 查看数据库当前的进程</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span></span><br><span class="line">| Id | User        | Host            | db   | Command | Time | State                    | Info                    | Progress |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span></span><br><span class="line">|  1 | system user |                 | NULL | Daemon  | NULL | InnoDB <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> coordinator | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">5</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">shutdown</span> <span class="keyword">handler</span>  | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">15</span> | root        | localhost:<span class="number">49914</span> | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | Init                     | <span class="keyword">show</span> <span class="keyword">processlist</span>        |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">40</span> | root        | localhost:<span class="number">50872</span> | <span class="keyword">test</span> | <span class="keyword">Sleep</span>   |   <span class="number">15</span> |                          | <span class="literal">NULL</span>                    |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">41</span> | root        | localhost:<span class="number">50888</span> | <span class="keyword">test</span> | <span class="keyword">Query</span>   |   <span class="number">11</span> | Updating                 | <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> c=<span class="number">1</span> |    <span class="number">0.000</span> |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+-------------------------+----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-当前运行的所有事务"><a href="#2-4-3-当前运行的所有事务" class="headerlink" title="(2.4.3) 当前运行的所有事务"></a>(2.4.3) 当前运行的所有事务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information_schema.INNODB_TRX;</span><br><span class="line">+<span class="comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span></span><br><span class="line">| trx_id | trx_state | trx_started         | trx_requested_lock_id | trx_wait_started    | trx_weight | trx_mysql_thread_id | trx_query               | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_is_read_only | trx_autocommit_non_locking |</span><br><span class="line">+<span class="comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span></span><br><span class="line">| 23312  | <span class="keyword">LOCK</span> <span class="keyword">WAIT</span> | <span class="number">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">18</span> | <span class="number">23312</span>:<span class="number">78</span>:<span class="number">3</span>:<span class="number">2</span>          | <span class="number">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">18</span> |          <span class="number">2</span> |                  <span class="number">41</span> | <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> c=<span class="number">1</span> | <span class="keyword">starting</span> <span class="keyword">index</span> <span class="keyword">read</span> |                 <span class="number">1</span> |                 <span class="number">1</span> |                <span class="number">2</span> |                  <span class="number">1136</span> |               <span class="number">1</span> |                 <span class="number">0</span> |                       <span class="number">0</span> | REPEATABLE <span class="keyword">READ</span></span><br><span class="line">     |                 <span class="number">1</span> |                      <span class="number">1</span> | <span class="literal">NULL</span>                       |                <span class="number">0</span> |                          <span class="number">0</span> |</span><br><span class="line">| <span class="number">23311</span>  | RUNNING   | <span class="number">2019</span><span class="number">-09</span><span class="number">-05</span> <span class="number">23</span>:<span class="number">16</span>:<span class="number">13</span> | <span class="literal">NULL</span>                  | <span class="literal">NULL</span>                |          <span class="number">3</span> |                  <span class="number">40</span> | <span class="literal">NULL</span>                    | <span class="literal">NULL</span></span><br><span class="line">    |                 <span class="number">0</span> |                 <span class="number">1</span> |                <span class="number">2</span> |                  <span class="number">1136</span> |               <span class="number">3</span> |                 <span class="number">1</span> |                       <span class="number">0</span> | REPEATABLE <span class="keyword">READ</span></span><br><span class="line">     |                 <span class="number">1</span> |                      <span class="number">1</span> | <span class="literal">NULL</span>                       |                <span class="number">0</span> |                          <span class="number">0</span> |</span><br><span class="line">+<span class="comment">--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+------------------+----------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-4-当前出现的锁"><a href="#2-4-4-当前出现的锁" class="headerlink" title="(2.4.4) 当前出现的锁"></a>(2.4.4) 当前出现的锁</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information_schema.INNODB_LOCKs;</span><br><span class="line">+<span class="comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span><br><span class="line">+<span class="comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line">| 23312:78:3:2 | 23312       | X         | RECORD    | `test`.`t` | PRIMARY    |         78 |         3 |        2 | 1         |</span><br><span class="line">| 23311:78:3:2 | 23311       | X         | RECORD    | `test`.`t` | PRIMARY    |         78 |         3 |        2 | 1         |</span><br><span class="line">+<span class="comment">--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-5-锁等待的对应关系"><a href="#2-4-5-锁等待的对应关系" class="headerlink" title="(2.4.5) 锁等待的对应关系"></a>(2.4.5) 锁等待的对应关系</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SELECT * FROM information_schema.INNODB_LOCK_waits;</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line">| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line">| 23312             | 23312:78:3:2      | 23311           | 23311:78:3:2     |</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-6-删除事务表中的事务"><a href="#2-4-6-删除事务表中的事务" class="headerlink" title="(2.4.6) 删除事务表中的事务"></a>(2.4.6) 删除事务表中的事务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;   SELECT   p.id,   p.time,         i.trx_id,       i.trx_state,    p.info FROM     INFORMATION_SCHEMA.PROCESSLIST p,       INFORMATION_SCHEMA.INNODB_TRX  i WHERE p.id = i.trx_mysql_thread_id    AND i.trx_state = 'LOCK WAIT';</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line">| id | time | trx_id | trx_state | info                    |</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line">| 41 |   27 | 23312  | <span class="keyword">LOCK</span> <span class="keyword">WAIT</span> | <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> c=<span class="number">1</span> |</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="2-4-7-kill掉锁表的语句"><a href="#2-4-7-kill掉锁表的语句" class="headerlink" title="(2.4.7) kill掉锁表的语句"></a>(2.4.7) kill掉锁表的语句</h3><p>  这儿有两种观点，一种是只kill掉后面等待的那个语句。还有一种是把两个语句都kill掉。这个根据实际情况处理。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; kill 41 ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;   SELECT   p.id,   p.time,         i.trx_id,       i.trx_state,    p.info FROM     INFORMATION_SCHEMA.PROCESSLIST p,       INFORMATION_SCHEMA.INNODB_TRX  i WHERE p.id = i.trx_mysql_thread_id    AND i.trx_state = 'LOCK WAIT';</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>  杀掉41</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist ;</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">| Id | User        | Host            | db   | Command | Time | State                    | Info             | Progress |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line">|  1 | system user |                 | NULL | Daemon  | NULL | InnoDB <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">2</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">3</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> coordinator | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">4</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">purge</span> worker      | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">|  <span class="number">5</span> | <span class="keyword">system</span> <span class="keyword">user</span> |                 | <span class="literal">NULL</span> | Daemon  | <span class="literal">NULL</span> | <span class="keyword">InnoDB</span> <span class="keyword">shutdown</span> <span class="keyword">handler</span>  | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">15</span> | root        | localhost:<span class="number">49914</span> | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | Init                     | <span class="keyword">show</span> <span class="keyword">processlist</span> |    <span class="number">0.000</span> |</span><br><span class="line">| <span class="number">40</span> | root        | localhost:<span class="number">50872</span> | <span class="keyword">test</span> | <span class="keyword">Sleep</span>   |   <span class="number">56</span> |                          | <span class="literal">NULL</span>             |    <span class="number">0.000</span> |</span><br><span class="line">+<span class="comment">----+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>  然后到第3个shell窗口查看，可以看到<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; delete from t where c=1 ;</span><br><span class="line">ERROR 1205 (HY000): <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>  因为第3个shell里执行的语句被kill掉了。</p>
<p>  到这儿可以看到死锁解决了。</p>
<p>  但其实有个问题。第3个shell里的语句被kill掉了。但第2个shell里的语句还在执行。如果第二个shell里的事务不提交或者kill，在第3个shell里执行删除语句还会造成锁表。</p>
<p>  第二种观点的办法<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	p.id,</span><br><span class="line">	p.time,</span><br><span class="line">	x.trx_id,</span><br><span class="line">	x.trx_state,</span><br><span class="line">	p.info </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	INFORMATION_SCHEMA.PROCESSLIST p,</span><br><span class="line">	INFORMATION_SCHEMA.INNODB_TRX  x </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	p.id = x.trx_mysql_thread_id  ;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT   p.id,   p.time,         x.trx_id,       x.trx_state,    p.info FROM     INFORMATION_SCHEMA.PROCESSLIST p,       INFORMATION_SCHEMA.INNODB_TRX  x WHERE</span><br><span class="line">p.id = x.trx_mysql_thread_id  ;</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line">| id | time | trx_id | trx_state | info                    |</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line">| 42 |    3 | 23317  | <span class="keyword">LOCK</span> <span class="keyword">WAIT</span> | <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> c=<span class="number">1</span> |</span><br><span class="line">| <span class="number">40</span> | <span class="number">1792</span> | <span class="number">23311</span>  | RUNNING   | <span class="literal">NULL</span>                    |</span><br><span class="line">+<span class="comment">----+------+--------+-----------+-------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>  然后同时杀掉 40  42 就可以。</p>
<h1 id="3-MySQL中的锁"><a href="#3-MySQL中的锁" class="headerlink" title="(3) MySQL中的锁"></a>(3) MySQL中的锁</h1><blockquote>
<p> 数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。<br>根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类。</p>
</blockquote>
<h2 id="3-1-全局锁"><a href="#3-1-全局锁" class="headerlink" title="(3.1) 全局锁"></a>(3.1) 全局锁</h2><p>  全局锁就是对整个数据库实例加锁。MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock (FTWRL)。当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。</p>
<p>  <strong> 全局锁的典型使用场景是，做全库逻辑备份。 </strong> 也就是把整库每个表都 select 出来存成文本。</p>
<p>  风险：<br>  1.如果在主库备份，在备份期间不能更新，业务停摆<br>  2.如果在从库备份，备份期间不能执行主库同步的binlog，导致主从延迟</p>
<p>  官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数–single-transaction 的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。<br>  你一定在疑惑，有了mysqldump这个功能，为什么还需要 FTWRL 呢？一致性读是好，但前提是引擎要支持这个隔离级别。比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用 FTWRL 命令了。<br>  比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用 FTWRL 命令了。<br>  single-transaction 方法只适用于所有的表使用事务引擎的库。如果有的表使用了不支持事务的引擎，那么备份就只能通过 FTWRL 方法。这往往是 DBA 要求业务开发人员使用 InnoDB 替代 MyISAM 的原因之一。</p>
<p>  全局锁主要用在逻辑备份过程中。对于全部是 InnoDB 引擎的库，建议你选择使用 <code>–single-transaction</code> 参数，对应用会更友好。</p>
<h2 id="3-2-表级锁"><a href="#3-2-表级锁" class="headerlink" title="(3.2) 表级锁"></a>(3.2) 表级锁</h2><p>  MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。</p>
<p>  表锁是在Server层实现的。ALTER TABLE之类的语句会使用表锁，忽略存储引擎的锁机制。</p>
<p>  <strong> 表锁的语法是 lock tables … read/write。</strong> 与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p>
<p>  举个例子, 如果在某个线程 A 中执行 lock tables t1 read, t2 write; 这个语句，则其他线程写 t1、读写 t2 的语句都会被阻塞。同时，线程 A 在执行 unlock tables 之前，也只能执行读 t1、读写 t2 的操作。连写 t1 都不允许，自然也不能访问其他表。</p>
<p>  在还没有出现更细粒度的锁的时候，表锁是最常用的处理并发的方式。而对于 InnoDB 这种支持行锁的引擎，一般不使用 lock tables 命令来控制并发，毕竟锁住整个表的影响面还是太大。</p>
<p>  <strong> 另一类表级的锁是 MDL（metadata lock)。 </strong><br>  MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的。</p>
<p>  因此，在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁。</p>
<p>  读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查。</p>
<p>  读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</p>
<p>  你现在应该知道了，事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。</p>
<p>  给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，你肯定会特别小心，以免对线上服务造成影响。而实际上，即使是小表，操作不慎也会出问题。在修改表的时候会持有MDL写锁，如果这个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p>
<p>  如何安全地给表加字段？<br>  首先我们要解决长事务，事务不提交，就会一直占着 MDL 锁。在 MySQL 的 information_schema 库的 innodb_trx 表中，你可以查到当前执行中的事务。如果你要做 DDL 变更的表刚好有长事务在执行，要考虑先暂停 DDL，或者 kill 掉这个长事务。<br>  这时候 kill 可能未必管用，因为新的请求马上就来了。比较理想的机制是，在 alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后开发人员或者 DBA 再通过重试命令重复这个过程。<br>  MariaDB 已经合并了 AliSQL 的这个功能，所以这两个开源分支目前都支持 DDL NOWAIT/WAIT n 这个语法。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">NOWAIT</span> <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name <span class="keyword">WAIT</span> N <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br></pre></td></tr></table></figure></p>
<p>  MDL 是并发情况下维护数据的一致性,在表上有事务的时候,不可以对元数据经行写入操作,并且这个是在server层面实现的<br>  当你做 dml 时候增加的 MDL 读锁, update table set id=Y where id=X; 并且由于隔离级别的原因 读锁之间不冲突</p>
<p>  当你DDL 时候 增加对表的写锁, 同时操作两个alter table 操作 这个要出现等待情况。</p>
<p>  但是 如果是 dml 与ddl 之间的交互 就更容易出现不可读写情况,这个情况容易session 爆满,session是占用内存的,也会导致内存升高<br>  MDL 释放的情况就是 事务提交.</p>
<h2 id="3-3-行锁"><a href="#3-3-行锁" class="headerlink" title="(3.3) 行锁"></a>(3.3) 行锁</h2><p>  MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。InnoDB 是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一。</p>
<p>  在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。<br>  知道了这个设定，对我们使用事务有什么帮助呢？那就是，如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。  </p>
<p>  假设你负责实现一个电影票在线交易业务，顾客 A 要在影院 B 购买电影票。我们简化一点，这个业务需要涉及到以下操作：</p>
<ol>
<li>从顾客 A 账户余额中扣除电影票价；</li>
<li>给影院 B 的账户余额增加这张电影票价；</li>
<li><p>记录一条交易日志。</p>
<p>试想如果同时有另外一个顾客 C 要在影院 B 买票，那么这两个事务冲突的部分就是语句 2 了。因为它们要更新同一个影院账户的余额，需要修改同一行数据。<br>根据两阶段锁协议，不论你怎样安排语句顺序，所有的操作需要的行锁都是在事务提交的时候才释放的。所以，如果你把语句 2 安排在最后，比如按照 3、1、2 这样的顺序，那么影院账户余额这一行的锁时间就最少。这就最大程度地减少了事务之间的锁等待，提升了并发度。</p>
</li>
</ol>
<p> 当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为死锁。这里我用数据库中的行锁举个例子。</p>
<p>当出现死锁以后，有两种策略：</p>
<ol>
<li>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置。 </li>
<li><p>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑。</p>
<p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s，意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。对于在线服务来说，这个等待时间往往是无法接受的。</p>
</li>
</ol>
<p>  你可以考虑通过将一行改成逻辑上的多行来减少锁冲突。还是以影院账户为例，可以考虑放在多条记录上，比如 10 个记录，影院的账户总额等于这 10 个记录的值的总和。这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的 1/10，可以减少锁等待个数，也就减少了死锁检测的 CPU 消耗。</p>
<h1 id="4-可能遇到的问题"><a href="#4-可能遇到的问题" class="headerlink" title="(4) 可能遇到的问题"></a>(4) 可能遇到的问题</h1><h2 id="4-1-备份一般都会在备库上执行，你在用–single-transaction-方法做逻辑备份的过程中，如果主库上的一个小表做了一个-DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？"><a href="#4-1-备份一般都会在备库上执行，你在用–single-transaction-方法做逻辑备份的过程中，如果主库上的一个小表做了一个-DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？" class="headerlink" title="(4.1) 备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？"></a>(4.1) 备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</h2><p>  备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</p>
<p>假设这个 DDL 是针对表 t1 的， 这里我把备份过程中几个关键的语句列出来：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Q1:<span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> REPEATABLE <span class="keyword">READ</span>;</span><br><span class="line">Q2:<span class="keyword">START</span> <span class="keyword">TRANSACTION</span>  <span class="keyword">WITH</span> <span class="keyword">CONSISTENT</span> <span class="keyword">SNAPSHOT</span>；</span><br><span class="line"><span class="comment">/* other tables */</span></span><br><span class="line">Q3:<span class="keyword">SAVEPOINT</span> sp;</span><br><span class="line"><span class="comment">/* 时刻 1 */</span></span><br><span class="line">Q4:<span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`t1`</span>;</span><br><span class="line"><span class="comment">/* 时刻 2 */</span></span><br><span class="line">Q5:<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`t1`</span>;</span><br><span class="line"><span class="comment">/* 时刻 3 */</span></span><br><span class="line">Q6:<span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> sp;</span><br><span class="line"><span class="comment">/* 时刻 4 */</span></span><br><span class="line"><span class="comment">/* other tables */</span></span><br></pre></td></tr></table></figure></p>
<p>在备份开始的时候，为了确保 RR（可重复读）隔离级别，再设置一次 RR 隔离级别 (Q1);<br>启动事务，这里用 WITH CONSISTENT SNAPSHOT 确保这个语句执行完就可以得到一个一致性视图（Q2)；<br>设置一个保存点，这个很重要（Q3）；<br>show create 是为了拿到表结构 (Q4)，然后正式导数据 （Q5），回滚到 SAVEPOINT sp，在这里的作用是释放 t1 的 MDL 锁 （Q6）。当然这部分属于“超纲”，上文正文里面都没提到。<br>DDL 从主库传过来的时间按照效果不同，我打了四个时刻。题目设定为小表，我们假定到达后，如果开始执行，则很快能够执行完成。</p>
<p>参考答案如下：</p>
<ol>
<li>如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是 DDL 后的表结构。<p></p></li>
<li>如果在“时刻 2”到达，则表结构被改过，Q5 执行的时候，报 Table definition has changed, please retry transaction，现象：mysqldump 终止；<p></p></li>
<li>如果在“时刻 2”和“时刻 3”之间到达，mysqldump 占着 t1 的 MDL 读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成。<p></p></li>
<li>从“时刻 4”开始，mysqldump 释放了 MDL 读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。<p></p></li>
</ol>
<h2 id="4-2-删数据问题"><a href="#4-2-删数据问题" class="headerlink" title="(4.2) 删数据问题"></a>(4.2) 删数据问题</h2><p> 如果你要删除一个表里面的前 10000 行数据，有以下三种方法可以做到：<br>  第一种，直接执行 delete from T limit 10000;<br>  第二种，在一个连接中循环执行 20 次 delete from T limit 500;<br>  第三种，在 20 个连接中同时执行 delete from T limit 500。</p>
<p>你会选择哪一种方法呢？为什么呢？</p>
<p>  方案一，事务相对较长，则占用锁的时间较长，会导致其他客户端等待资源时间较长。<br>  方案二，串行化执行，将相对长的事务分成多次相对短的事务，则每次事务占用锁的时间相对较短，其他客户端在等待相应资源的时间也较短。这样的操作，同时也意味着将资源分片使用（每次执行使用不同片段的资源），可以提高并发性。<br>  方案三，人为自己制造锁竞争，加剧并发量。  </p>
<h2 id="4-3-问题3"><a href="#4-3-问题3" class="headerlink" title="(4.3) 问题3"></a>(4.3) 问题3</h2><p>1.如何在死锁发生时,就把发生的sql语句抓出来？<br>2.在使用连接池的情况下,连接会复用.比如一个业务使用连接set sql_select_limit=1,释放掉以后.其他业务复用该连接时,这个参数也生效.请问怎么避免这种情况,或者怎么禁止业务set session？<br>3.很好奇双11的成交额,是通过redis累加的嘛？<br>4.不会改源码能成为专家嘛？ </p>
<ol>
<li>show engine innodb status 里面有信息，不过不是很全…</li>
<li>5.7的reset_connection接口可以考虑一下</li>
<li>用redis的话，为了避免超卖需要增加了很多机制来保证。修改都在数据库里执行就方便点。前提是要解决热点问题</li>
<li>我认识几位处理问题和分析问题经验非常丰富的专家，不用懂源码，但是原理还是要很清楚的</li>
</ol>
<h2 id="4-4-转义导致死锁问题"><a href="#4-4-转义导致死锁问题" class="headerlink" title="(4.4) 转义导致死锁问题"></a>(4.4) 转义导致死锁问题</h2><p>前天在开发中，还遇到过一次死锁，是在一个批处理中，要删除1000条数据，5个线程，200条数据commit一次，<br>sol：delete from 表A where id =15426169754750004759008 STORAGEDB<br>(id是主键)<br>我同事解决了，说原因是id 是char 类型，但是没有加单引号，所以没有进入id索引中，然后锁表了，所以导致死锁。</p>
<p>这个问题的出现，应该是人为只要并发导致锁冲突吧？但是为什么不加单引号会死锁，加了单引号就能正常跑呢？  </p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p>[1] <a href="https://blog.csdn.net/dujianxiong/article/details/90770301" target="_blank" rel="noopener">Mysql 锁、事务强制手动kill/释放</a><br>[2] <a href="https://time.geekbang.org/column/article/74687" target="_blank" rel="noopener">19 | 为什么我只查一行的语句，也执行这么慢？MySQL实战45讲 </a><br>[3] <a href="https://time.geekbang.org/column/article/69862" target="_blank" rel="noopener">06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？MySQL实战45讲 </a><br>[4] <a href="https://time.geekbang.org/column/article/70215" target="_blank" rel="noopener">07 | 行锁功过：怎么减少行锁对性能的影响？MySQL实战45讲</a><br>[5] <a href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html" target="_blank" rel="noopener">mysql 5.7 lock-tables</a><br>[6] 《高性能MySQL》 O’REILLY</p>
<!--
插入10万数据

delimiter ;;
create procedure idata()
begin
  declare i int;
  set i=1;
  while(i<=100000) do
    insert into t values(i,i);
    set i=i+1;
  end while;
end;;
delimiter ;

call idata();
-->
<!--
____    __    ____  _______  __      __  ___  _______      ______      __  .__   __. 
\   \  /  \  /   / |   ____||  |    |  |/  / |   ____|    /  __  \    |  | |  \ |  | 
 \   \/    \/   /  |  |__   |  |    |  '  /  |  |__      |  |  |  |   |  | |   \|  | 
  \            /   |   __|  |  |    |    <   |   __|     |  |  |  |   |  | |  . `  | 
   \    /\    /    |  |____ |  |    |  .  \  |  |____    |  `--'  '--.|  | |  |\   | 
    \__/  \__/     |_______||__|    |__|\__\ |_______|    \_____\_____\__| |__| \__| 



             _   _               _      
 _ _ _  ___ <_> | |__ ___   ___ <_>._ _ 
| | | |/ ._>| | | / // ._> / . || || ' |
|__/_/ \___.|_| |_\_\\___. \_  ||_||_|_|
                             |_|        


 __    __  ____ __    __ __  ____      ___   __ __  __
 ||    || ||    ||    || // ||        // \\  || ||\ ||
 \\ /\ // ||==  ||    ||<<  ||==     ((   )) || ||\\||
  \V/\V/  ||___ ||    || \\ ||___     \\_/X| || || \||






                                                           iiii       kkkkkkkk                                                       iiii                   
                                                          i::::i      k::::::k                                                      i::::i                  
                                                           iiii       k::::::k                                                       iiii                   
                                                                      k::::::k                                                                              
wwwwwww           wwwww           wwwwwww eeeeeeeeeeee   iiiiiii       k:::::k    kkkkkkk eeeeeeeeeeee            qqqqqqqqq   qqqqqiiiiiiinnnn  nnnnnnnn    
 w:::::w         w:::::w         w:::::wee::::::::::::ee i:::::i       k:::::k   k:::::kee::::::::::::ee         q:::::::::qqq::::qi:::::in:::nn::::::::nn  
  w:::::w       w:::::::w       w:::::we::::::eeeee:::::eei::::i       k:::::k  k:::::ke::::::eeeee:::::ee      q:::::::::::::::::q i::::in::::::::::::::nn 
   w:::::w     w:::::::::w     w:::::we::::::e     e:::::ei::::i       k:::::k k:::::ke::::::e     e:::::e     q::::::qqqqq::::::qq i::::inn:::::::::::::::n
    w:::::w   w:::::w:::::w   w:::::w e:::::::eeeee::::::ei::::i       k::::::k:::::k e:::::::eeeee::::::e     q:::::q     q:::::q  i::::i  n:::::nnnn:::::n
     w:::::w w:::::w w:::::w w:::::w  e:::::::::::::::::e i::::i       k:::::::::::k  e:::::::::::::::::e      q:::::q     q:::::q  i::::i  n::::n    n::::n
      w:::::w:::::w   w:::::w:::::w   e::::::eeeeeeeeeee  i::::i       k:::::::::::k  e::::::eeeeeeeeeee       q:::::q     q:::::q  i::::i  n::::n    n::::n
       w:::::::::w     w:::::::::w    e:::::::e           i::::i       k::::::k:::::k e:::::::e                q::::::q    q:::::q  i::::i  n::::n    n::::n
        w:::::::w       w:::::::w     e::::::::e         i::::::i     k::::::k k:::::ke::::::::e               q:::::::qqqqq:::::q i::::::i n::::n    n::::n
         w:::::w         w:::::w       e::::::::eeeeeeee i::::::i     k::::::k  k:::::ke::::::::eeeeeeee        q::::::::::::::::q i::::::i n::::n    n::::n
          w:::w           w:::w         ee:::::::::::::e i::::::i     k::::::k   k:::::kee:::::::::::::e         qq::::::::::::::q i::::::i n::::n    n::::n
           www             www            eeeeeeeeeeeeee iiiiiiii     kkkkkkkk    kkkkkkk eeeeeeeeeeeeee           qqqqqqqq::::::q iiiiiiii nnnnnn    nnnnnn
                                                                                                                           q:::::q                          
                                                                                                                           q:::::q                          
                                                                                                                          q:::::::q                         
                                                                                                                          q:::::::q                         
                                                                                                                          q:::::::q                         
                                                                                                                          qqqqqqqqq                         

██╗    ██╗███████╗██╗    ██╗  ██╗███████╗     ██████╗ ██╗███╗   ██╗
██║    ██║██╔════╝██║    ██║ ██╔╝██╔════╝    ██╔═══██╗██║████╗  ██║
██║ █╗ ██║█████╗  ██║    █████╔╝ █████╗      ██║   ██║██║██╔██╗ ██║
██║███╗██║██╔══╝  ██║    ██╔═██╗ ██╔══╝      ██║▄▄ ██║██║██║╚██╗██║
╚███╔███╔╝███████╗██║    ██║  ██╗███████╗    ╚██████╔╝██║██║ ╚████║
 ╚══╝╚══╝ ╚══════╝╚═╝    ╚═╝  ╚═╝╚══════╝     ╚══▀▀═╝ ╚═╝╚═╝  ╚═══╝


-->
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mysql/" rel="tag"># mysql</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/18/java-core-technology-36-lectures/" rel="next" title="Java核心技术36讲 杨晓峰">
                <i class="fa fa-chevron-left"></i> Java核心技术36讲 杨晓峰
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/08/redis-solve-what-problem/" rel="prev" title="Redis的各项功能解决了哪些问题">
                Redis的各项功能解决了哪些问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">WKQ</p>
              <p class="site-description motion-element" itemprop="description">不积跬步无以至千里</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">163</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">55</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/wkq278276130" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:weikeqin.cn@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/u/0/107737814703120725006" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/wkq278276130" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.facebook.com/keqin.wei.5" target="_blank" title="FB Page"><i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://stackoverflow.com/users/8054088/wkq" target="_blank" title="StackOverflow"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-遇到锁表快速解决办法"><span class="nav-number">1.</span> <span class="nav-text">(1)  遇到锁表快速解决办法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-复盘"><span class="nav-number">2.</span> <span class="nav-text">(2) 复盘</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-创建表t并插入2条数据"><span class="nav-number">2.1.</span> <span class="nav-text">(2.1) 创建表t并插入2条数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-准备多个shell模拟锁表"><span class="nav-number">2.2.</span> <span class="nav-text">(2.2) 准备多个shell模拟锁表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-模拟锁表"><span class="nav-number">2.3.</span> <span class="nav-text">(2.3) 模拟锁表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-锁表后查看"><span class="nav-number">2.4.</span> <span class="nav-text">(2.4) 锁表后查看</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-查看是否锁表"><span class="nav-number">2.4.1.</span> <span class="nav-text">(2.4.1)查看是否锁表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-查看数据库当前的进程"><span class="nav-number">2.4.2.</span> <span class="nav-text">(2.4.2) 查看数据库当前的进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-当前运行的所有事务"><span class="nav-number">2.4.3.</span> <span class="nav-text">(2.4.3) 当前运行的所有事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-4-当前出现的锁"><span class="nav-number">2.4.4.</span> <span class="nav-text">(2.4.4) 当前出现的锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-5-锁等待的对应关系"><span class="nav-number">2.4.5.</span> <span class="nav-text">(2.4.5) 锁等待的对应关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-6-删除事务表中的事务"><span class="nav-number">2.4.6.</span> <span class="nav-text">(2.4.6) 删除事务表中的事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-7-kill掉锁表的语句"><span class="nav-number">2.4.7.</span> <span class="nav-text">(2.4.7) kill掉锁表的语句</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-MySQL中的锁"><span class="nav-number">3.</span> <span class="nav-text">(3) MySQL中的锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-全局锁"><span class="nav-number">3.1.</span> <span class="nav-text">(3.1) 全局锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-表级锁"><span class="nav-number">3.2.</span> <span class="nav-text">(3.2) 表级锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-行锁"><span class="nav-number">3.3.</span> <span class="nav-text">(3.3) 行锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-可能遇到的问题"><span class="nav-number">4.</span> <span class="nav-text">(4) 可能遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-备份一般都会在备库上执行，你在用–single-transaction-方法做逻辑备份的过程中，如果主库上的一个小表做了一个-DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？"><span class="nav-number">4.1.</span> <span class="nav-text">(4.1) 备份一般都会在备库上执行，你在用–single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-删数据问题"><span class="nav-number">4.2.</span> <span class="nav-text">(4.2) 删数据问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-问题3"><span class="nav-number">4.3.</span> <span class="nav-text">(4.3) 问题3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-转义导致死锁问题"><span class="nav-number">4.4.</span> <span class="nav-text">(4.4) 转义导致死锁问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WKQ</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a> v6.3.0
  <span>｜one of Hosted by 
	 <a href="https://pages.coding.me" rel="external nofollow">Coding Pages</a>
  </span>
</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=65182271";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz',
        appKey: 'IeozLmM20GuvfcslfWgdNXP0',
        placeholder: '期待您的评论',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=6.3.0"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("Ca876j76FoCQi1SShjT0qC6k-gzGzoHsz", "IeozLmM20GuvfcslfWgdNXP0");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.get('time'));
            
            counter.save(null, {
              success: function(counter) {
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! See more at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see here how to solve it: https://github.com/theme-next/hexo-leancloud-counter-security. \n But you also can use LeanCloud without security, by set \'security\' option to \'false\'.');
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  

  

</body>
</html>
